<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .card {
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-badge {
            font-size: 0.8rem;
        }
        .profit-positive {
            color: #28a745;
            font-weight: bold;
        }
        .profit-negative {
            color: #dc3545;
            font-weight: bold;
        }
        .table-hover tbody tr:hover {
            background-color: #f8f9fa;
        }
        .config-value {
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-currency-exchange"></i>
                币安自动交易系统
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text" id="current-time">
                    <i class="bi bi-clock"></i>
                    <span id="time-display"></span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- 左侧控制面板 -->
            <div class="col-lg-3">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <i class="bi bi-gear"></i>
                        系统控制
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button id="start-btn" class="btn btn-success" onclick="startTrading()">
                                <i class="bi bi-play-fill"></i>
                                启动交易
                            </button>
                            <button id="stop-btn" class="btn btn-danger" onclick="stopTrading()" disabled>
                                <i class="bi bi-stop-fill"></i>
                                停止交易
                            </button>
                        </div>
                        <hr>
                        <div class="mb-3">
                            <label class="form-label">系统状态:</label>
                            <span id="system-status" class="badge bg-secondary">未知</span>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">运行时间:</label>
                            <span id="runtime" class="text-muted">-</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-info text-white">
                        <i class="bi bi-graph-up"></i>
                        风险监控
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">最大回撤:</label>
                            <div class="progress">
                                <div id="drawdown-progress" class="progress-bar" 
                                     role="progressbar" style="width: 0%">
                                    0%
                                </div>
                            </div>
                            <small class="text-muted">限制: 10%</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">账户余额:</label>
                            <span id="account-balance" class="text-muted">-</span>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">权益价值:</label>
                            <span id="equity-value" class="text-muted">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 中间主要内容 -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <i class="bi bi-bar-chart-fill"></i>
                        交易统计
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="text-center">
                                    <h5 id="total-trades">0</h5>
                                    <small class="text-muted">总交易次数</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center">
                                    <h5 id="win-rate">0%</h5>
                                    <small class="text-muted">胜率</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center">
                                    <h5 id="net-profit">0.00</h5>
                                    <small class="text-muted">净收益(USDT)</small>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-muted">总收益:</small>
                                <span id="total-profit">0.00</span>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">总手续费:</small>
                                <span id="total-fees">0.00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <i class="bi bi-list-check"></i>
                        当前持仓
                    </div>
                    <div class="card-body">
                        <div id="position-info" class="text-center text-muted">
                            暂无持仓信息
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <i class="bi bi-clock-history"></i>
                        最近交易
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>时间</th>
                                        <th>方向</th>
                                        <th>数量</th>
                                        <th>价格</th>
                                        <th>手续费</th>
                                    </tr>
                                </thead>
                                <tbody id="trade-history">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">暂无交易记录</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧配置信息 -->
            <div class="col-lg-3">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <i class="bi bi-sliders"></i>
                        配置参数
                    </div>
                    <div class="card-body">
                        <div id="config-info">
                            <div class="mb-2">
                                <small class="text-muted">交易对:</small>
                                <span class="config-value" id="config-symbol">BTCUSDT</span>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">杠杆:</small>
                                <span class="config-value" id="config-leverage">10x</span>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">K线周期:</small>
                                <span class="config-value" id="config-intervals">5m,15m</span>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">风险控制:</small>
                                <span class="config-value" id="config-risk">2%/单</span>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">最大回撤:</small>
                                <span class="config-value" id="config-drawdown">10%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-light">
                        <i class="bi bi-info-circle"></i>
                        系统信息
                    </div>
                    <div class="card-body">
                        <div class="small text-muted">
                            <div>版本: 1.0.0</div>
                            <div>最后更新: <span id="last-update">-</span></div>
                            <div>数据刷新: <span id="refresh-rate">5秒</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let refreshInterval;
        
        // 更新时间显示
        function updateTime() {
            const now = new Date();
            document.getElementById('time-display').textContent = now.toLocaleString('zh-CN');
        }
        
        // 获取系统状态
        async function fetchStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                updateStatusDisplay(data);
            } catch (error) {
                console.error('获取状态失败:', error);
            }
        }
        
        // 更新状态显示
        function updateStatusDisplay(data) {
            // 系统状态
            const statusBadge = document.getElementById('system-status');
            statusBadge.textContent = data.status === 'running' ? '运行中' : '已停止';
            statusBadge.className = data.status === 'running' ? 'badge bg-success' : 'badge bg-secondary';
            
            // 控制按钮
            document.getElementById('start-btn').disabled = data.status === 'running';
            document.getElementById('stop-btn').disabled = data.status !== 'running';
            
            // 运行时间
            if (data.runtime) {
                const hours = Math.floor(data.runtime / 3600);
                const minutes = Math.floor((data.runtime % 3600) / 60);
                const seconds = Math.floor(data.runtime % 60);
                document.getElementById('runtime').textContent = 
                    `${hours}时 ${minutes}分 ${seconds}秒`;
            }
            
            // 风险监控
            if (data.max_drawdown !== undefined) {
                const drawdownPercent = (data.max_drawdown * 100).toFixed(2);
                const progressBar = document.getElementById('drawdown-progress');
                progressBar.style.width = `${drawdownPercent}%`;
                progressBar.textContent = `${drawdownPercent}%`;
                progressBar.className = drawdownPercent >= 10 ? 
                    'progress-bar bg-danger' : 'progress-bar';
            }
            
            // 账户信息
            if (data.account_balance !== undefined) {
                document.getElementById('account-balance').textContent = 
                    `${data.account_balance.toFixed(2)} USDT`;
            }
            if (data.equity_value !== undefined) {
                document.getElementById('equity-value').textContent = 
                    `${data.equity_value.toFixed(2)} USDT`;
            }
            
            // 交易统计
            if (data.trading_stats) {
                const stats = data.trading_stats;
                document.getElementById('total-trades').textContent = stats.total_trades;
                document.getElementById('win-rate').textContent = `${stats.win_rate.toFixed(1)}%`;
                document.getElementById('net-profit').textContent = stats.net_profit.toFixed(2);
                document.getElementById('net-profit').className = stats.net_profit >= 0 ? 
                    'profit-positive' : 'profit-negative';
                document.getElementById('total-profit').textContent = stats.total_profit.toFixed(2);
                document.getElementById('total-fees').textContent = stats.total_fees.toFixed(4);
            }
            
            // 持仓信息
            updatePositionDisplay(data.current_position);
            
            // 配置信息
            if (data.config) {
                updateConfigDisplay(data.config);
            }
            
            // 最后更新时间
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString('zh-CN');
        }
        
        // 更新持仓显示
        function updatePositionDisplay(position) {
            const positionElement = document.getElementById('position-info');
            
            if (!position || position.positionAmt === '0') {
                positionElement.innerHTML = '<div class="text-muted">暂无持仓</div>';
                return;
            }
            
            const amount = parseFloat(position.positionAmt);
            const entryPrice = parseFloat(position.entryPrice);
            const unrealizedProfit = parseFloat(position.unRealizedProfit);
            
            const positionType = amount > 0 ? '多仓' : '空仓';
            const profitClass = unrealizedProfit >= 0 ? 'profit-positive' : 'profit-negative';
            
            positionElement.innerHTML = `
                <div class="row">
                    <div class="col-6">
                        <small class="text-muted">方向:</small>
                        <div>${positionType}</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">数量:</small>
                        <div>${Math.abs(amount).toFixed(4)}</div>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-6">
                        <small class="text-muted">入场价:</small>
                        <div>${entryPrice.toFixed(2)}</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">浮动盈亏:</small>
                        <div class="${profitClass}">${unrealizedProfit.toFixed(2)}</div>
                    </div>
                </div>
            `;
        }
        
        // 更新配置显示
        function updateConfigDisplay(config) {
            if (config.trading) {
                document.getElementById('config-symbol').textContent = config.trading.symbol;
                document.getElementById('config-leverage').textContent = `${config.trading.leverage}x`;
            }
            
            if (config.kline) {
                document.getElementById('config-intervals').textContent = 
                    config.kline.intervals.join(',');
            }
            
            if (config.risk_management) {
                const riskPct = config.risk_management.risk_per_trade * 100;
                document.getElementById('config-risk').textContent = `${riskPct.toFixed(1)}%/单`;
                document.getElementById('config-drawdown').textContent = 
                    `${(config.risk_management.max_drawdown * 100).toFixed(1)}%`;
            }
        }
        
        // 获取交易历史
        async function fetchTradeHistory() {
            try {
                const response = await fetch('/api/trades?limit=10');
                const trades = await response.json();
                updateTradeHistoryDisplay(trades);
            } catch (error) {
                console.error('获取交易历史失败:', error);
            }
        }
        
        // 更新交易历史显示
        function updateTradeHistoryDisplay(trades) {
            const tbody = document.getElementById('trade-history');
            
            if (!trades || trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">暂无交易记录</td></tr>';
                return;
            }
            
            tbody.innerHTML = trades.map(trade => {
                const time = new Date(trade.timestamp * 1000).toLocaleTimeString('zh-CN');
                const sideClass = trade.side === 'BUY' ? 'text-success' : 'text-danger';
                
                return `
                    <tr>
                        <td>${time}</td>
                        <td class="${sideClass}">${trade.side}</td>
                        <td>${parseFloat(trade.quantity).toFixed(4)}</td>
                        <td>${parseFloat(trade.price).toFixed(2)}</td>
                        <td>${parseFloat(trade.fee).toFixed(4)}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // 启动交易
        async function startTrading() {
            try {
                const response = await fetch('/api/start', { method: 'POST' });
                const result = await response.json();
                alert(result.message);
                fetchStatus(); // 刷新状态
            } catch (error) {
                alert('启动失败: ' + error.message);
            }
        }
        
        // 停止交易
        async function stopTrading() {
            try {
                const response = await fetch('/api/stop', { method: 'POST' });
                const result = await response.json();
                alert(result.message);
                fetchStatus(); // 刷新状态
            } catch (error) {
                alert('停止失败: ' + error.message);
            }
        }
        
        // 初始化页面
        function initializePage() {
            updateTime();
            setInterval(updateTime, 1000);
            
            // 初始加载数据
            fetchStatus();
            fetchTradeHistory();
            
            // 设置定时刷新
            refreshInterval = setInterval(() => {
                fetchStatus();
                fetchTradeHistory();
            }, 5000); // 每5秒刷新一次
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>